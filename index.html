<html>
    <head>
        <link rel="shortcut icon" href="http://www.ranchobiosciences.com/wp-content/uploads/2016/04/Rancho-map.png" />
        <link rel="stylesheet" href="styles/codemirror.css">
        <link rel="stylesheet" href="styles/codemirror-neo.css">
        <link rel="stylesheet" href="styles/cy2neo.css">
        <link rel="stylesheet" href="styles/neod3.css">
        <link rel="stylesheet" href="styles/datatable.css">
        <link rel="stylesheet" href="styles/vendor.css"> <!-- bootstrap-->
        <link rel="stylesheet" href="styles/sweet-alert.css">
        <link rel="stylesheet" href="styles/gh-fork-ribbon.css">
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/css/select2.min.css" />
        <link rel="stylesheet" href="styles/di.css">
        <title>Cy2NeoD3 - Tiny Neo4j Cypher Workbench</title>
    </head>

    <script>
        //var apiServer="http://ns527777.ip-149-56-18.net:8085";
        var apiServer="http://10.33.36.143:8081";
        var validNodeProperties;
        function runScript(e) {
            if (e.keyCode == 13) {
                var config = {}
                var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
                new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true, false);
                return false;
            }
        }

        function makeCy(){
            var queryTerm = document.getElementById("term").value;
            document.getElementById("cypher").value=queryTerm;
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

    </script>
    <body>
        <div class="authentication" style="background-color: #212831;">
            <div class="logo" style="padding-top:15px;width:'25%'; float:left;"><a id="dnn_dnnLogo_hypLogo" title="Digital Infuzion - Home Page" href="http://www.digitalinfuzion.com/Home.aspx">
                <img id="dnn_dnnLogo_imgLogo" src="http://www.digitalinfuzion.com/Portals/0/Logo.png?ver=2015-10-29-163414-967" alt="Digital Infuzion - Home Page" /></a>
            </div>
            <div style="float:right;padding-top: 15px; color: white; font-size:0.75em;">
                <form id="diAPILoginForm" method="post">
                    Username: &nbsp; <input type="text" name="username" id="diAPIUsername">
                    Password: &nbsp; <input type="password" name="password" id="diAPIPassword" >
                    <input type="submit" value="Submit" id="diAPISubmit">
                </form>
            </div>
            <div id="authStatus" style="color:white; float:right;"></div>
        </div>

        

        <div class="ontomanage">
            
            <div class="nodeControls" align="right">
                <form name="nodes" id="nodes">
                    <input class="createnode" type="button" id="createnodebtn" onclick="createNodeBtnPressed()" value="Create New Node"/>
                    <input class="showaudittrail" type="button" id="showaudittrail" onclick="showAuditTrailBtnPressed()" value="Audit Trail"/>
                    <input class="showusersettings" type="button" id="showusersettings" onclick="showUserSettingsBtnPressed()" value="User Settings"/>
                </form>
            </div>

            <div class="usersettings">
                
                <div class="relationshipVisibilitySettings">
                </div>
                <div class="usersettingsbtns">
                    <input class="saveusersettings" type="button" id="saveusersettings" onclick="saveUserSettingsBtnPressed()" value="Save User Settings"/>
                    <input class="cancelusersettings" type="button" id="cancelusersettings" onclick="hideUserSettings()" value="Close"/>
                </div>
            </div>
            
            
            <div class="primaryNode" align="right">
                <form>
                    <input class="savenode" type="button" id="savenode" onclick="saveNode()" value="Save Node"/>
                    <input class="deletenode" type="button" id="deletenodebtn" onclick="deleteNodeBtnPressed()" value="Delete Node"/>
                    <input class="savenewnode" type="button" id="savenewnode" onclick="saveNewNode()" value="Save New Node"/>
                    <input class="mngreltns" type="button" id="mngreltnsbtn" onclick="displayCreateRelationshipControls()" value="Create A Relationship"/>    
                </form>
                <div id="primaryiriannunciator"></div>
                <div id="primaryNodeProperties"></div>
            </div>



            <div class="relationshipControl">
                <form>
                    <select id="relationshipDropdown"></select> 
                        <input class="createrelationship" type="button" id="createrelationship" value="Create Relationship"/>
                        <input class="modifyrelationship" type="button" id="modifyrelationship" value="Modify relationship"/>
                        <input class="deleterelationship" type="button" id="deleterelationship" value="Delete relationship"/>
                        <input class="cancelnewrelations" type="button" id="cancelnewrelations" value="cancel"/>
                </form>
            </div>
            <div class="secondaryNode" align="right">
                <div id="secondaryiriannunciator"></div>
                <div id="secondaryNodeProperties"></div>

            </div>

            <div class="auditTrail">
                <form>
                    <input class="applyaudittrail" type="button" id="applyaudittrail" onclick="applyAuditTrailBtnPressed()" value="Apply Audit Trail"/>
                    <input class="closeaudittrail" type="button" id="closeaudittrail" onclick="closeAuditTrailBtnPressed()" value="Close"/>
                    <input class="downloadaudittrail" type="button" id="downloadaudittrail" onclick="downloadAuditTrailBtnPressed()" value="Download Last Audit Trail Replay Log"/>
                </form>
                <div id="audittrailgrid" style="height: 100%; width:100%" class="ag-theme-fresh"></div>
            </div>
        </div>  

        <div class="ontodisplay">
	       Search for:
            <div>
                <form>
                    <input class="form-control" type="hidden" value="" id="neo4jUrl"/>
                    <input class="form-control" type="hidden" size="8" value="neo4j" id="neo4jUser"/>
                    <input class="form-control" type="hidden" size="8" placeholder="password" value="test" id="neo4jPass"/>

                    <textarea name="cypher" id="cypher" rows="4" cols="120" data-lang="cypher" class="code form-control"></textarea>

                    <input class="form-control" type="text" name="term" id="term" size="60" onkeypress="makeCy();return runScript(event);" onKeyUp="makeCy();">
                    <a href="#" title="Execute" id="execute" style="display:none"><i class="fa fa-play-circle-o"></i></a>
                </form>
            </div>

            <div id="tabpanel" role="tabpanel">

                <form action="">
                    <div id="authenticatedSearchOptions" style="float:right; padding-left:5px;font-size:0.9em;"> 
                        <input type="radio" name="searchmethod" value="iriSearch" > Search by IRI
                        <input type="radio" name="searchmethod" value="BSVEIRISearch" > Search by BSVE IRI (Use * to get all BSVE Nodes)
                    </div>
                    <div style="float:right; padding-left:5px; font-size:0.9em;">

                        <input type="radio" name="searchmethod" value="labelSearch" checked="checked"> Search by Label
                        <input type="radio" name="searchmethod" value="bsveSearch" >BSVE Search &nbsp;
                    </div>	
                    <div id="showAllRelationshipsOption">
                        <input type="checkbox" name="showallrelationships" value="true"> Show All Relationships<br> 
                    </div>

                </form>
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#graph" aria-controls="home" role="tab" data-toggle="tab">Graph</a></li>
                    <li role="presentation"><a href="#table" aria-controls="table" role="tab" data-toggle="tab">Table</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="graph">
                        <div class="tab-pane active" id="graph">&nbsp;</div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="table">
                        <div id="datatable"></div>
                    </div>
                </div>  
            </div>
	

            <script src="scripts/codemirror.js"></script>
            <script src="scripts/codemirror-cypher.js"></script>
            <script src="scripts/vendor.js"></script>
            <script src="scripts/sweet-alert.min.js"></script>
            <script src="scripts/neod3.js"></script>
            <script src="scripts/neod3-visualization.js"></script>
            <script src="scripts/neo4d3.js"></script>
            <script src="scripts/cy2neod3.js"></script>
            <script src="scripts/jquery.dataTables.min.js"></script>
            <script src="scripts/cypher.datatable.js"></script>
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/js/select2.full.min.js"></script>
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/14.2.0/ag-grid.min.js"></script>


            <script type="text/javascript">
                var relationshipIRI="";
                var currentUserDetails={};
                var allUserData = [];
                var gridOptions ={};
                $(document).ready(function() {
                    document.getElementById("term").value=getParameterByName("term");
                    $("input[id=neo4jUrl]").val(apiServer + "/DIOntoManager");
                    makeCy();
                    $(".secondaryNode").hide();

                    $(".relationshipControl").hide();
                    $("#savenode").hide();
                    $("#savenewnode").hide();
                    $("#deletenodebtn").hide();
                    $("#mngreltnsbtn").hide();
                    $(".auditTrail").hide();
                    hideUserSettings();


                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/user/authenticate',
                        type: 'GET',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){

                            console.log(data);
                            currentUserDetails=data;
                            $('#diAPILoginForm').hide();
                            $('.relationshipControl').hide();
                            $('#authStatus').html("Welcome " + currentUserDetails.User + " (<span onClick=\"logout()\" id=\"logout\">logout</span>)");
                            $('#authStatus').show();
                            if (currentUserDetails.viewnode_authorized){
                                getValidNodeProperties();

                                $(".ontomanage").show();
                                $(".ontodisplay").width("65%");
                                if (!currentUserDetails.modifynode_authorized){
                                    changeToViewerUserUI();
                                }
                                else {
                                    changeToModifierUserUI();
                                    if (currentUserDetails.doidUpdateAvailable) {
                                        alert ("A DOID update has been detected and downloaded.\nPlease merge with BSVE and apply the audit trail");
                                    } else if (currentUserDetails.auditReplayRequired){
                                        alert ("An update to the underlying BSVE ontology has been detected.\nPlease apply the Audit trail to bring the graph database up to date");
                                    }
                                }

                            }
                            else {
                                $(".ontomanage").hide();
                                $(".ontodisplay").width("100%");
                            }
                        },
                        error: function(){
                            $(".ontomanage").hide();
                            $(".ontodisplay").width("100%");
                            changeToUnAuthenticatedDisplay()
                        }
                    });

                    var columnDefinitions = [
                        {
                            headerName: "Date",
                            field: "date",
                            editable: false,
                            filter: 'date',
                            minWidth: 110,
                            width:110,
                            filterParams:{
                                comparator:function (filterLocalDateAtMidnight, cellValue){
                                    var dateAsString = cellValue;
                                    var dateParts  = dateAsString.split("-");
                                    var cellDate = new Date(Number(dateParts[0]), Number(dateParts[1]) - 1, Number(dateParts[2]));

                                    if (filterLocalDateAtMidnight.getTime() == cellDate.getTime()) {
                                        return 0
                                    }

                                    if (cellDate < filterLocalDateAtMidnight) {
                                        return -1;
                                    }

                                    if (cellDate > filterLocalDateAtMidnight) {
                                        return 1;
                                    }
                                }
                            },
                            suppressToolPanel: true,
                            menuTabs:['filterMenuTab']
                        },
                        {
                            headerName: "Cypher Query",
                            field: "cypherquery",
                            editable: false,
                            filter: 'text',
                            suppressToolPanel: true,
                            minWidth: 200,
                            width: 374,
                            cellStyle: {'white-space': 'normal'},
                            menuTabs:['filterMenuTab']
                        },
                        {
                            headerName: "User", field: "user", editable: false, filter: 'text', minWidth: 70, width: 70, suppressToolPanel: true, menuTabs:['filterMenuTab']
                        },
                    ];
                    
                    gridOptions = {
                        enableSorting: true,
                        pagination: true,
                        enableFilter: true,
                        enableColResize: true,
                        getRowHeight: function(params) {
                            return 18 * (Math.floor(params.data.cypherquery.length / 24) + 1);
                        },
                        
                        rowData: allUserData,
                        columnDefs: columnDefinitions,
                    }; 
                    
                    var gridDiv = $('#audittrailgrid')[0];
                    new agGrid.Grid(gridDiv, gridOptions);
                    
                    gridOptions.api.addEventListener("gridSizeChanged", auditTrailGridSizeChangedHandler);

                    var config = {}
                    var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
                    new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true, false);
                });

                function checkIfUserTimedOut(messageIfNot){
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/user/authenticate',
                        type: 'GET',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){

                            alert(messageIfNot);
                        },
                        error: function(){
                            $(".ontomanage").hide();
                            $(".ontodisplay").width("100%");
                            changeToUnAuthenticatedDisplay();
                            alert("Your session has timed out, please relog in to continue");
                        }
                    });

                }

                function auditTrailGridSizeChangedHandler(){
                    gridOptions.api.sizeColumnsToFit();
                }

                function changeToUnAuthenticatedDisplay(){
                    $(".nodeControls").hide();
                    $(".relationshipControl").hide();
                    $("#authenticatedSearchOptions").hide();
                }

                function changeToViewerUserUI(){
                    $(".nodeControls").hide();
                    $("#savenode").hide();
                    $("#deletenodebtn").hide();
                    $("#mngreltnsbtn").hide();
                    $(".relationshipControl").hide();
                    $("#authenticatedSearchOptions").show();
                    $("#primaryNodeProperties").jsGrid({
                        width: "100%",
                        height: "100%",

                        inserting: false,
                        editing: false,
                        sorting: false,
                        paging: false,

                        data: [],
                        fields: [
                            { name: "Property", type: "select", items:validNodeProperties, valueField:"Name", textField:"Name" },
                            { name: "Value", type: "text" },
                            { type: "control", width: 50 }
                        ]
                    });

                    $("#secondaryNodeProperties").jsGrid({
                        width: "100%",
                        height: "100%",
                        inserting: false,
                        editing: false,
                        sorting: false,
                        paging: false,

                        data: [],
                        fields: [
                            { name: "Property", type: "select", items:validNodeProperties, valueField:"Name", textField:"Name" },
                            { name: "Value", type: "text" },
                            { type: "control", width: 50 }
                        ]
                    });
                    
                    $("#primaryNodeProperties").jsGrid("refresh");
                    $("#secondaryNodeProperties").jsGrid("refresh");
                    $(".secondaryNode").hide()
                }

                function changeToModifierUserUI(){
                    $(".nodeControls").show();
                    $("#authenticatedSearchOptions").show();
                }

                function initManageRelationshipControls(relationshipType){
                    $("#relationshipDropdown").width("40%");
                    $(".secondaryNode").show();
                    $(".primaryNode").show();
                
                    $("#relationshipDropdown").select2({
              		    tags: true,
              		    ajax: {
                  		    url: apiServer+'/DIOntoManager/api/neo4j/relationship/find',
                  		    type: 'GET',
                  		    dataType: 'json',
                  		    xhrFields: {
                    		  withCredentials: true
                  		    },
                  		    data: function (params) {
                  			   console.log(params);
                  			   var query = {
                    	           relationshipName: params.term,
                  			   }
                               return query;
                            },
                  		    processResults: function(data, params){
                                for (i=0; i<data.length; i++){
                                    if (data[i].text===relationshipType){
                                        selectedRelationshipId=data[i].id;
                  				  }
                  			   };
                  			   return {
                  				  results: data
                  			   }
                  		    }
                        }
                    });
                    // $('#relationshipDropdown').select2().val(selectedRelationshipId).trigger('change.select2');
                    $(".relationshipControl").show();
                }

                function getValidNodeProperties(){
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/node/properties/getall',
                        type: 'GET',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            validNodeProperties=JSON.parse(data);
                        },

                        error: function(err) {
                            checkIfUserTimedOut(err.status);
                            
                        }
                    });
                }

                function logout(){
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/user/logout',
                        type: 'GET',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            alert(data);
                            $('#authStatus').hide();
                            $('#diAPILoginForm').show();
                            $(".ontomanage").hide();
                            $(".ontodisplay").width("100%");
                            changeToUnAuthenticatedDisplay();
                        },

                        error: function(err) {
                            alert (err.status);
                            $(".ontomanage").hide();
                            $(".ontodisplay").width("100%");
                            changeToUnAuthenticatedDisplay();
                        }
                    });
                };

                function displayCreateRelationshipControls(){
                    closeAuditTrailBtnPressed();
                    if($("#savenode").is(":visible")){
                        initManageRelationshipControls();
                        $(".secondaryNode").show();
                        $("#createrelationship").show();
                        $("#modifyrelationship").hide();
                        $("#deleterelationship").hide();
                        $("#savenode").hide();
                        $("#deletenodebtn").hide();
                        $("#mngreltnsbtn").hide();
                        $(".primaryNode").height('40%');
                        $(".secondaryNode").height('40%');
                    }
                    else {
            		  alert("Please select a subject node for the relationship");
            	   }
                }

                function applyAuditTrailBtnPressed(){
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/audittrail/apply',
                        type: 'GET',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            alert(data);
                            //alert(JSON.stringify(JSON.parse(data), null, 4));
                        },

                        error: function(err) {
                            checkIfUserTimedOut(err.status);
                            
                        }
                    });
                }

                function hideUserSettings(){
                    $(".usersettings").hide();
                }

                function downloadAuditTrailBtnPressed(){
                    window.open(apiServer+'/DIOntoManager/api/neo4j/audittraillog/download');
                    
                }

                function saveNode(){
                    var primaryNodeProperties = $("#primaryNodeProperties").jsGrid("option", "data");
                    var requestBodyString="";
                    for (var i=0; i<primaryNodeProperties.length; i++){
                        var primaryNodeProperty = primaryNodeProperties[i];
                        for (var key in primaryNodeProperty){
                            if (key==="Property"){
                                requestBodyString=requestBodyString+primaryNodeProperty[key]+"=";
                            }
                            else {
                                requestBodyString=requestBodyString+primaryNodeProperty[key]+"&";
                            }
                        }
                    }
                    requestBodyString=requestBodyString+"iri="+$("#primaryiriannunciator").html().substring(15);
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/node/modify',
                        type: 'POST',
                        data: requestBodyString,
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            console.log(data);
                            var config = {}
                            var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
                            new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true, false);
                        },
                        error: function(xhr, status, error){
                            checkIfUserTimedOut(err.status);
                            //alert(xhr.statusText);
                            //console.log(xhr.statusText);
                            //var err =JSON.parse(xhr.responseText);
                            //alert(err.Message);
                        }
                    })
                    console.log(requestBodyString);
                }

                function saveNewNode(){
                    var primaryNodeProperties = $("#primaryNodeProperties").jsGrid("option", "data");
                    var requestBodyString="";
                    console.log(primaryNodeProperties);
                    for (var i=0; i<primaryNodeProperties.length; i++){
                        var primaryNodeProperty = primaryNodeProperties[i];
                        for (var key in primaryNodeProperty){
                            if (key==="Property"){
                                requestBodyString=requestBodyString+primaryNodeProperty[key]+"=";
                            }
                            else {
                                requestBodyString=requestBodyString+primaryNodeProperty[key]+"&";
                            }
                        }
                    }
                    //requestBodyString=requestBodyString;
                    console.log("Request body is " + requestBodyString);
                    if (requestBodyString.trim()!==""){
                        $.ajax({
                            url: apiServer+'/DIOntoManager/api/neo4j/node/create',
                            type: 'POST',
                            data: requestBodyString,
                            xhrFields: {
                                withCredentials: true
                            },
                            success: function(data){
                                alert(data);
                                console.log(data);
                                var config = {}
                                var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
                                new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true, false);
                                console.log("Create node query is " + requestBodyString);
                            },
                            error: function(xhr, status, error){
                                checkIfUserTimedOut(err.status);
                                //alert(xhr.statusText);
                                //console.log(xhr.statusText + xhr.status);
                                //var err =JSON.parse(xhr.responseText);
                                //alert(err.Message);
                            }
                        })
                    }
                    else {
                        alert("All created nodes must have a \"label\" parameter")
                    }
                
                }

                function initializeCreateNodeControls(){
                    $("#savenode").hide();
                    $("#deletenodebtn").hide();
                    $("#mngreltnsbtn").hide();
                    $("#savenewnode").show();
                    $(".secondaryNode").hide();
                    $(".relationshipControl").hide();
                    $("#primaryiriannunciator").html("");
                    $("#primaryNodeProperties").jsGrid("refresh");
                    $(".primaryNode").show();
                }

                function showUserSettingsBtnPressed(){
                   // $(".ontomanage").hide();
                    $(".relationshipVisibilitySettings").html("Loading settings...");
                    $(".usersettingsbtns").hide();
                    $(".usersettings").show();

                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/settings/get',
                        type: 'GET',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            var userOptions = JSON.parse(data);
                            console.log(userOptions);
                            var userSettingsHTML = '<h4>Show Relationships</h4>';
                            for (var i=0; i<userOptions.length; i++){
                                var checked = "";
                                if (userOptions[i].visible){
                                    checked = " checked";
                                }
                                
                                userSettingsHTML = userSettingsHTML + '<input type="checkbox" name="'+userOptions[i].relationship +'" value="'+userOptions[i].relationship +'"' + checked +'> &nbsp;' +userOptions[i].relationship + ' <br>';
                                //$(".usersettings").html('<input type="checkbox" name="'+userOptions[i].relationship +'" value="'+userOptions[i].relationship +' ' + checked +'">' +userOptions[i].relationship + ' <br>');
                            }
                            console.log(userSettingsHTML + '</form>');
                            $(".relationshipVisibilitySettings").html(userSettingsHTML);
                             $(".usersettingsbtns").show();
                            //console.log("Create node query is " + requestBodyString);
                                    //$("#secondaryiriannunciator").html("");
                        },
                        error: function(xhr, status, error){
                            checkIfUserTimedOut(err.status);
                            //alert(xhr.statusText);
                            //console.log(xhr.statusText + xhr.status);
                            //var err =JSON.parse(xhr.responseText);
                            //alert(err.Message);
                        }
                    })
                }

                function saveUserSettingsBtnPressed(){
                    var visibibleRelationships = "";
                    $(".relationshipVisibilitySettings :input").each(function (index, data){
                        console.log(data);
                        if(data['checked']){
                            visibibleRelationships =visibibleRelationships + '`'+data.value + '`' + "|";
                        }
                    })

                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/settings/save',
                        type: 'POST',
                        data: 'visibleRelationships='+visibibleRelationships+"&",
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                           alert(data);
                            //console.log("Create node query is " + requestBodyString);
                                    //$("#secondaryiriannunciator").html("");
                        },
                        error: function(xhr, status, error){
                            checkIfUserTimedOut(err.status);
                            //alert(xhr.statusText);
                            //console.log(xhr.statusText + xhr.status);
                            //var err =JSON.parse(xhr.responseText);
                            //alert(err.Message);
                        }
                    });
                }

                function showAuditTrailBtnPressed(){
                    $(".primaryNode").hide();
                    $("#cancelnewrelations").click();
                    hideUserSettings();
                    
                    $(".auditTrail").show();
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/audittrail/view',
                        type: 'GET',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            gridOptions.api.setRowData(JSON.parse(data));
                            //console.log("Create node query is " + requestBodyString);
                                    //$("#secondaryiriannunciator").html("");
                        },
                        error: function(xhr, status, error){
                            checkIfUserTimedOut(err.status);
                            //alert(xhr.statusText);
                            //console.log(xhr.statusText + xhr.status);
                            //var err =JSON.parse(xhr.responseText);
                            //alert(err.Message);
                        }
                    });
                }

                function closeAuditTrailBtnPressed(){
                    $(".auditTrail").hide();
                }

                function deleteNodeBtnPressed(){
                    closeAuditTrailBtnPressed();
                    if($("#savenode").is(":visible")){
                        if (confirm("Please confirm deletion of " + $("#primaryiriannunciator").html().substring(15)) == true) {
                            //alert ("we will delete " + $("#primaryiriannunciator").html().substring(15));
                            var requestBodyString="nodeIRI="+$("#primaryiriannunciator").html().substring(15)+"&";
                 
                            $.ajax({
                                url: apiServer+'/DIOntoManager/api/neo4j/node/delete',
                                type: 'POST',
                                data: requestBodyString,
                                xhrFields: {
                                    withCredentials: true
                                },
                                success: function(data){
                                    alert(JSON.stringify(data));
                                    var config = {};
                                    var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
                                    new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true, false);
                                    //console.log("Create node query is " + requestBodyString);
                                    //$("#secondaryiriannunciator").html("");
                                },
                                error: function(xhr, status, error){
                                    checkIfUserTimedOut(err.status);
                      		        //alert(xhr.statusText);
                                    //console.log(xhr.statusText + xhr.status);
                                    //var err =JSON.parse(xhr.responseText);
                                    //alert(err.Message);
                                }
                            });
                        }
                        else {
                            alert("Cancelled Deletion");
                        }
                    }
                    else{
              		    alert("Please select a node to delete");
                    }
                }

                function createNodeBtnPressed(){
                    initializeCreateNodeControls();
                    closeAuditTrailBtnPressed();
                    hideUserSettings();
                    $("#primaryNodeProperties").jsGrid({
                        width: "100%",
                        height: "100%",

                        inserting: true,
                        editing: true,
                        sorting: false,
                        paging: false,

                        data: [],
                        fields: [
                            { name: "Property", type: "select", items:validNodeProperties, valueField:"Name", textField:"Name" },
                            { name: "Value", type: "text" },
                            { type: "control", deleteButton: false, width: 50 }
                        ]
                    });
                }

                function getlastindex(){
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/getlastindex',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            $("#primaryNodeProperties").jsGrid({
                                width: "100%",
                                height: "100%",

                                inserting: true,
                                editing: true,
                                sorting: false,
                                paging: false,
                                data: [],
                                fields: [
                                    { name: "Property", type: "text" },
                                    { name: "Value", type: "text" },
                                    { type: "control", width: 50 }
                                ]
                            });
                            $("#savenode").hide();
                            $("#deletenodebtn").hide();
                            $("#mngreltnsbtn").hide();
                            $("#savenewnode").show();
                            $(".secondaryNode").hide();
                            $(".relationshipControl").hide();
                            var lastIRIi=parseInt(data);
                            lastIRIi=lastIRIi+1;
                            $("#primaryiriannunciator").html("Properties for http://purl.obolibrary.org/obo/BSVE_" +lastIRIi);
                            $("#primaryNodeProperties").jsGrid("refresh");
                        },
                        error: function(xhr, status, error){
                            checkIfUserTimedOut(err.status);
                            //alert(xhr.statusText);
                            //var err =JSON.parse(xhr.responseText);
                            //alert(err.Message);
                        }
                    })

                };

                $("#deleterelationship").click(function(){
                    //alert("cancelling");
                    //alert ("an ajax call to create the relationship will be sent to the back end");
                    var requestBodyString="subject="+$("#primaryiriannunciator").html().substring(15)+"&";
                    requestBodyString=requestBodyString+"object="+$("#secondaryiriannunciator").html().substring(15)+"&";
                    requestBodyString=requestBodyString+"relationship="+relationshipIRI;
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/nodes/relationship/delete',
                        type: 'POST',
                        data: requestBodyString,
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            alert(data);
                            console.log(data);
                            var config = {}
                            var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
                            new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true, false);
                            $("#cancelnewrelations").click();
                            //console.log("Create node query is " + requestBodyString);
                            //$("#secondaryiriannunciator").html("");
                        },
                        error: function(xhr, status, error){
                            checkIfUserTimedOut(err.status);
                            //alert(xhr.statusText);
                            //console.log(xhr.statusText + xhr.status);
                            //var err =JSON.parse(xhr.responseText);
                            //alert(err.Message);
                        }
                    });
                });

                $("#modifyrelationship").click(function(){
                    //alert("we will create a relationship of" + $('#relationshipDropdown option:selected').text());
                    var requestBodyString="subject="+$("#primaryiriannunciator").html().substring(15)+"&";
                    requestBodyString=requestBodyString+"object="+$("#secondaryiriannunciator").html().substring(15)+"&";
                    requestBodyString=requestBodyString+"oldrelationship="+relationshipIRI+"&";
                    requestBodyString=requestBodyString+"newrelationship="+$('#relationshipDropdown option:selected').text();
                    //console.log(requestBodyString);
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/nodes/relationship/modify',
                        type: 'POST',
                        data: requestBodyString,
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            alert(data);
                            console.log(data);
                            var config = {}
                            var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
                            new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true, false);
                            $("#cancelnewrelations").click();
                            //console.log("Create node query is " + requestBodyString);
                       
                        },
                        error: function(xhr, status, error){
                            checkIfUserTimedOut(err.status);
                            //alert(xhr.statusText);
                            //console.log(xhr.statusText + xhr.status);
                            //var err =JSON.parse(xhr.responseText);
                            //alert(err.Message);
                        }
                    });
                });

                $("#createrelationship").click(function(){
                    //alert("cancelling");
                    //alert ("an ajax call to create the relationship will be sent to the back end");
                    var requestBodyString="subject="+$("#primaryiriannunciator").html().substring(15)+"&";
                    requestBodyString=requestBodyString+"object="+$("#secondaryiriannunciator").html().substring(15)+"&";
                    requestBodyString=requestBodyString+"relationship="+$('#relationshipDropdown option:selected').text();
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/neo4j/nodes/relationship/create',
                        type: 'POST',
                        data: requestBodyString,
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            alert(data);
                            console.log(data);
                            var config = {}
                            var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
                            new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true, false);
                            //console.log("Create node query is " + requestBodyString);
                            //$("#secondaryiriannunciator").html("");
                        },
                        error: function(xhr, status, error){
                            checkIfUserTimedOut(err.status);
                            //alert(xhr.statusText);
                            //console.log(xhr.statusText + xhr.status);
                            //var err =JSON.parse(xhr.responseText);
                            //alert(err.Message);
                        }
                    });

                    $("#secondaryNodeProperties").jsGrid({
                        width: "100%",
                        height: "100%",

                        inserting: true,
                        editing: true,
                        sorting: false,
                        paging: false,

                        data: [],
                        fields: [
                            { name: "Property", type: "select", items:validNodeProperties, valueField:"Name", textField:"Name" },
                            { name: "Value", type: "text" },
                            { type: "control", width: 50 }
                        ]
                    });
                    
                    $(".primaryNode").height('100%');
                    $(".secondaryNode").hide();
                    $(".relationshipControl").hide();
                    $("#savenode").show();
                    $("#deletenodebtn").show();
                    $("#mngreltnsbtn").show();
                    $("#secondaryNodeProperties").jsGrid("refresh");
                });

                $("#cancelnewrelations").click(function(){
                    //alert("cancelling");
                    $("#secondaryNodeProperties").jsGrid({
                        width: "100%",
                        height: "100%",

                        inserting: true,
                        editing: true,
                        sorting: false,
                        paging: false,

                        data: [],
                        fields: [
                            { name: "Property", type: "select", items:validNodeProperties, valueField:"Name", textField:"Name" },
                            { name: "Value", type: "text" },
                            { type: "control", width: 50 }
                        ]
                    });
                    $(".primaryNode").height('100%');
                    $(".secondaryNode").hide();
                    $(".relationshipControl").hide();
                    if(currentUserDetails.modifynode_authorized){
                        $("#savenode").show();
                        $("#deletenodebtn").show();
                        $("#mngreltnsbtn").show();

                    }
                    else{
                        $("#savenode").hide();
                        $("#deletenodebtn").hide();
                        $("#mngreltnsbtn").hide();
                    }
                    $("#secondaryNodeProperties").jsGrid("refresh");
                    $("#secondaryiriannunciator").html("");
                });

                $("#diAPILoginForm").submit(function(e){
                    $.ajax({
                        url: apiServer+'/DIOntoManager/api/user/login',
                        type: 'POST',
                        data: $('#diAPILoginForm').serialize(),
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function(data){
                            var inCorrectCredentials = "Incorrect Username or Password";
                            if(!data.Authenticated){
                                alert("Incorrect Username or Password");
                                changeToUnAuthenticatedDisplay();
                            }
                            else {
                                //getValidNodeProperties();
                                hideUserSettings();
                                currentUserDetails=data;
                     
                                $('#diAPILoginForm').hide();
                                $('#authStatus').html("<font size=\"1\">Welcome " + currentUserDetails.User + " (<span onClick=\"logout()\" id=\"logout\">logout</span>)</font>");
                                $('#authStatus').show();
                                if (currentUserDetails.viewnode_authorized || currentUserDetails.modifynode_authorized){
                                    getValidNodeProperties();
                                    $(".ontomanage").show();
                                    $(".ontodisplay").width("65%");
                                    if(currentUserDetails.modifynode_authorized){
                      		            changeToModifierUserUI();
                                        if (currentUserDetails.doidUpdateAvailable) {
                                            alert ("A DOID update has been detected and downloaded.\nPlease merge with BSVE and apply the audit trail");
                                        }
                                        else if (currentUserDetails.auditReplayRequired){
                                            alert ("An update to the underlying BSVE ontology has been detected.\nPlease apply the Audit trail to bring the graph database up to date");
                                        }
                                    }
                                    else{
                                        changeToViewerUserUI();
                                    }
                                }
                            }
                        },
                        error: function(err) {
                            alert (err.status)
                        }
                    });
                    e.preventDefault();
                })
            </script>
            <div id="syn" style="display:none; background-color:rgba(250, 250, 250, 0.9);" onClick="this.style='display:none;'"> </div>
        </div>
        <div style="position:absolute; bottom: 10px; padding:10px; font-size:0.5em;" width="100%" align="right">powered by <a href="http://www.ranchobiosciences.com"><img src="http://www.ranchobiosciences.com/wp-content/uploads/2016/01/Rancho.png" height="25" alt="Rancho BioSciences"></a></div>
    </body>
</html>