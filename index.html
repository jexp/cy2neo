<html>
<head>
  <link rel="stylesheet" href="styles/codemirror.css">
  <link rel="stylesheet" href="styles/codemirror-neo.css">
  <link rel="stylesheet" href="styles/cy2neo.css">
  <link rel="stylesheet" href="styles/neod3.css">
  <link rel="stylesheet" href="styles/datatable.css">
  <link rel="stylesheet" href="styles/vendor.css"> <!-- bootstrap-->
  <link rel="stylesheet" href="styles/sweet-alert.css">
  <link rel="stylesheet" href="styles/gh-fork-ribbon.css">
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
  <title>Cy2NeoD3 - Tiny Neo4j Cypher Workbench</title>
</head>

<script>
  var apiServer="http://10.33.36.143:8081";
  function runScript(e) {
    if (e.keyCode == 13) {
      var config = {}
      var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
      new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true);
      return false;
    }
  }

  function makeCy(){
    var queryTerm = document.getElementById("term").value;
    document.getElementById("cypher").value=queryTerm;
  //document.getElementById("cypher").value='match (n)-[r:subClassOf|`http://purl.obolibrary.org/obo/doid#has_material_basis_in`]->(m) where m.label =~ "(?i)'+queryTerm+'" OR n.label =~ "(?i)'+queryTerm+'" OR ANY (item IN n.`http://www.geneontology.org/formats/oboInOwl#hasExactSynonym` WHERE item=~"(?i)' + queryTerm + '") OR ANY (item IN n.`http://digitalInfuzion.com/ontology/bsve/bsve_do#hasSynonym` WHERE item=~"(?i)' + queryTerm + '") OR ANY (item IN n.synonym WHERE item=~"(?i)' + queryTerm + '") or ANY (item IN m.`http://www.geneontology.org/formats/oboInOwl#hasExactSynonym` WHERE item=~"(?i)' + queryTerm + '") OR ANY (item IN m.`http://digitalInfuzion.com/ontology/bsve/bsve_do#hasSynonym` WHERE item=~"(?i)' + queryTerm + '") OR ANY (item IN m.synonym WHERE item=~"(?i)' + queryTerm + '")  return (n)-[r]->(m) limit 50';
  //document.getElementById("cypher").value='match (n)-[r]->(m) where n.label CONTAINS "'+document.getElementById("term").value+'" return (n)-[r]->(m) limit 50';
//alert (document.getElementById("cypher").value);
}

function getParameterByName(name, url) {
  if (!url) url = window.location.href;
  name = name.replace(/[\[\]]/g, "\\$&");
  var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
  results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, " "));
}

</script>
<body>
  <div class="ontomanage">
    <div class="authentication">
      <form id="diAPILoginForm" method="post">
        <div id="credentials">
          <font size="1">Username:<input type="text" name="username" id="diAPIUsername" ></font>
          <font size="1">Password:<input type="password" name="password" id="diAPIPassword" ></font>
          <font size="1"><input type="submit" value="Submit"></font>
        </div>
      </form>
      <div id="authStatus">
      </div>
    </div>
    <div class="nodeControls">
      <form>
        <input class="createnode" type="button" id="createnodebtn" onclick="createNodeBtnPressed()" value="Create New Node"/>
        <input class="mngreltns" type="button" id="mngreltnsbtn" onclick="showSecondayProperties()" value="Manage Current Node Relationships"/>
      </form>
    </div>
    <div class="secondaryNode">
      <div id="secondaryiriannunciator"></div>
      <div id="secondaryNodeProperties">
      </div>

    </div>
    <div class="relationshipControl">
     <select>
      <option value="isSubclassOf">isSubclassOf</option>
      <option value="has_material_basis_in">has_material_basis_in</option>
      <option value="hasExactSynonym">hasExactSynonym</option>
      <option value="hasSynonym">hasSynonym</option>
    </select> 
    <input class="submitnewrelations" type="button" id="submitnewrelations" value="submit"/>
    <input class="cancelnewrelations" type="button" id="cancelnewrelations" value="cancel"/>
  </div>
  <div class="primaryNode">
    <input class="savenode" type="button" id="savenode" onclick="saveNode()" value="Save Node"/>
    <input class="savenewnode" type="button" id="savenewnode" onclick="saveNewNode()" value="Save New Node"/>
    <div id="primaryiriannunciator"></div>
    <div id="primaryNodeProperties">
    </div>
  </div>
</div>  
<div class="ontodisplay">
  <div>
    <form>
      <input class="form-control" type="hidden" value="http://10.33.36.143:8081/DIOntoManager" id="neo4jUrl"/><br/>
      <input class="form-control" type="hidden" size="8" value="neo4j" id="neo4jUser"/>
      <input class="form-control" type="hidden" size="8" placeholder="password" value="test" id="neo4jPass"/><br/>

      <textarea name="cypher" id="cypher" rows="4" cols="120" data-lang="cypher" class="code form-control">
      </textarea>

      <input class="form-control" type="text" name="term" id="term" size="60" onkeypress="makeCy();return runScript(event);" onKeyUp="makeCy();">
      <a href="#" title="Execute" id="execute" style="display:none"><i class="fa fa-play-circle-o"></i></a>
    </form>
  </div>

  <div role="tabpanel">
    <form action="">
      <input type="radio" name="searchmethod" value="doidSearch"> Doid Search
      <input type="radio" name="searchmethod" value="generalSearch" checked="checked"> General Search
    </form>
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
      <li role="presentation" class="active"><a href="#graph" aria-controls="home" role="tab" data-toggle="tab">Graph</a></li>
      <li role="presentation"><a href="#table" aria-controls="table" role="tab" data-toggle="tab">Table</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
      <div role="tabpanel" class="tab-pane active" id="graph">
       <div class="tab-pane active" id="graph">&nbsp;</div>
     </div>
     <div role="tabpanel" class="tab-pane" id="table">
       <div id="datatable"></div>
     </div>
   </div>  
 </div>

 <script src="scripts/codemirror.js"></script>
 <script src="scripts/codemirror-cypher.js"></script>
 <script src="scripts/vendor.js"></script>
 <script src="scripts/sweet-alert.min.js"></script>
 <script src="scripts/neod3.js"></script>
 <script src="scripts/neod3-visualization.js"></script>
 <script src="scripts/neo4d3.js"></script>
 <script src="scripts/cy2neod3.js"></script>
 <script src="scripts/jquery.dataTables.min.js"></script>
 <script src="scripts/cypher.datatable.js"></script>
 <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>



 <script type="text/javascript">
  $(document).ready(function() {
    document.getElementById("term").value=getParameterByName("term");
    makeCy();
    $(".secondaryNode").hide();
    $(".relationshipControl").hide();
    $("#savenode").hide();
    $("#savenewnode").hide();
      //parIt("cypher");
      //parIt("neo4jUrl");
      //todo dynamic configuration
      $.ajax({
        url: apiServer+'/DIOntoManager/api/user/authenticate',
        type: 'GET',
        xhrFields: {
          withCredentials: true
        },
        success: function(data){
          $('#diAPILoginForm').hide();
          $('#authStatus').html("<font size=\"1\">" + data + " (<span onClick=\"logout()\" id=\"logout\">logout</span>)</font>");
          $('#authStatus').show();
        }
      })
      var config = {}
      var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
      new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true);
    });

  function logout(){
    $.ajax({
      url: apiServer+'/DIOntoManager/api/user/logout',
      type: 'GET',
      xhrFields: {
        withCredentials: true
      },
      success: function(data){
        alert(data);
        $('#authStatus').hide();
        $('#diAPILoginForm').show();

      },

      error: function(err) {
        alert (err.status)
      }
    })
  };

  function showSecondayProperties(){
    $(".secondaryNode").show();
    $(".relationshipControl").show();
    $("#savenode").hide();
  }

  function saveNode(){
    var primaryNodeProperties = $("#primaryNodeProperties").jsGrid("option", "data");
    var requestBodyString="";
    for (var i=0; i<primaryNodeProperties.length; i++){
      var primaryNodeProperty = primaryNodeProperties[i];
      for (var key in primaryNodeProperty){
        if (key==="Property"){
          requestBodyString=requestBodyString+primaryNodeProperty[key]+"=";
        }
        else {
          requestBodyString=requestBodyString+primaryNodeProperty[key]+"&";
        }
      }
    }
    requestBodyString=requestBodyString+"iri="+$("#primaryiriannunciator").html().substring(15);
    $.ajax({
      url: apiServer+'/DIOntoManager/api/neo4j/node/modify',
      type: 'POST',
      data: requestBodyString,
      xhrFields: {
        withCredentials: true
      },
      success: function(data){
        console.log(data);
        var config = {}
        var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
        new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true);
      },
      error: function(xhr, status, error){
        console.log(xhr.statusText);
          //var err =JSON.parse(xhr.responseText);
          //alert(err.Message);
      }
    })
    console.log(requestBodyString);
  }

  function saveNewNode(){
    var primaryNodeProperties = $("#primaryNodeProperties").jsGrid("option", "data");
    var requestBodyString="";
    console.log(primaryNodeProperties);
    for (var i=0; i<primaryNodeProperties.length; i++){
      var primaryNodeProperty = primaryNodeProperties[i];
      for (var key in primaryNodeProperty){
        if (key==="Property"){
          requestBodyString=requestBodyString+primaryNodeProperty[key]+"=";
        }
        else {
          requestBodyString=requestBodyString+primaryNodeProperty[key]+"&";
        }
      }
    }
    //requestBodyString=requestBodyString;
    console.log("Request body is " + requestBodyString);
    if (requestBodyString.trim()!==""){
      $.ajax({
        url: apiServer+'/DIOntoManager/api/neo4j/node/create',
        type: 'POST',
        data: requestBodyString,
        xhrFields: {
          withCredentials: true
        },
        success: function(data){
          alert(data);
          console.log(data);
          var config = {}
          var connection = function() { return {url:$("#neo4jUrl").val(), user:$("#neo4jUser").val(),pass:$("#neo4jPass").val()}; }
          new Cy2NeoD3(config,"graph","datatable","cypher","execute", connection , true);
          console.log("Create node query is " + requestBodyString);
        },
        error: function(xhr, status, error){
          alert(xhr.statusText);
          console.log(xhr.statusText + xhr.status);
          //var err =JSON.parse(xhr.responseText);
          //alert(err.Message);
        }
      })
    }
    else {
      alert("All created nodes must have a \"rdflabel\" parameter")
    }
    
  }

  function createNodeBtnPressed(){
    $("#primaryNodeProperties").jsGrid({
      width: "100%",
      height: "100%",

      inserting: true,
      editing: true,
      sorting: false,
      paging: false,

      data: [],
      fields: [
      { name: "Property", type: "text" },
      { name: "Value", type: "text" },
      { type: "control", deleteButton: false, width: 50 }
      ]
    });
    $("#savenode").hide();
    $("#savenewnode").show();
    $(".secondaryNode").hide();
    $(".relationshipControl").hide();
    $("#primaryNodeProperties").jsGrid("refresh");
  }

  function getlastindex(){
    $.ajax({
      url: apiServer+'/DIOntoManager/api/neo4j/getlastindex',
      xhrFields: {
        withCredentials: true
      },
      success: function(data){
        $("#primaryNodeProperties").jsGrid({
          width: "100%",
          height: "100%",

          inserting: true,
          editing: true,
          sorting: false,
          paging: false,

          data: [],
          fields: [
          { name: "Property", type: "text" },
          { name: "Value", type: "text" },
          { type: "control", width: 50 }
          ]
        });
        $("#savenode").hide();
        $("#savenewnode").show();
        $(".secondaryNode").hide();
        $(".relationshipControl").hide();
        var lastIRIi=parseInt(data);
        lastIRIi=lastIRIi+1;
        $("#primaryiriannunciator").html("Properties for http://purl.obolibrary.org/obo/BSVE_" +lastIRIi);
        $("#primaryNodeProperties").jsGrid("refresh");
      },
      error: function(xhr, status, error){
        alert(xhr.statusText);
          //var err =JSON.parse(xhr.responseText);
          //alert(err.Message);
        }
      })

  };

  $("#submitnewrelations").click(function(){
      //alert("cancelling");
      alert ("an ajax call to create the relationship will be sent to the back end");
      $(".secondaryNode").hide();
      $(".relationshipControl").hide();
      $("#savenode").show();

    });

  $("#cancelnewrelations").click(function(){
      //alert("cancelling");
      $(".secondaryNode").hide();
      $(".relationshipControl").hide();
      $("#savenode").show();

    });

  $("#diAPILoginForm").submit(function(e){
    $.ajax({
      url: apiServer+'/DIOntoManager/api/user/login',
      type: 'POST',
      data: $('#diAPILoginForm').serialize(),
      xhrFields: {
        withCredentials: true
      },
      success: function(data){
        var inCorrectCredentials = "Incorrect Username or Password";
        if(data.trim() === inCorrectCredentials){
          alert(data);
        }
        else {

          $('#diAPILoginForm').hide();
          $('#authStatus').html("<font size=\"1\">" + data + " (<span onClick=\"logout()\" id=\"logout\">logout</span>)</font>");
          $('#authStatus').show();
        }
      },
      error: function(err) {
        alert (err.status)
      }
    })
    e.preventDefault(); 
  })
</script>
<div id="syn" style="display:none; background-color:rgba(250, 250, 250, 0.9);" onClick="this.style='display:none;'"> </div>
</div>
</body>
</html>